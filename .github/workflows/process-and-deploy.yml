name: Process Articles & Deploy

on:
  schedule:
    # Lance automatiquement tous les jours √† 20h UTC (vous pouvez changer)
    - cron: '0 20 * * *'

  # Permet aussi un d√©clenchement manuel
  workflow_dispatch:

  # Optionnel: se d√©clenche quand une issue est cr√©√©e/modifi√©e
  issues:
    types: [opened, edited]

jobs:
  process:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Process articles
        env:
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_USER: martinregent
          REPO_NAME: veille
        run: |
          python scripts/process_veille.py

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # V√©rifier s'il y a des changements
          if git diff --quiet; then
            echo "‚úÖ Aucun changement √† committer"
          else
            git add -A
            git commit -m "üì∞ Traitement automatique des articles

Nouvelles fiches g√©n√©r√©es et publi√©es.
Traitement d√©clench√© par GitHub Actions.

$(date)"
            git push origin main
          fi

      - name: Comment on issues
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ Votre article a √©t√© ajout√© √† la veille!\n\n' +
                    'La prochaine ex√©cution du script de traitement (programm√©e √† 20h UTC) g√©n√©rera automatiquement une fiche r√©sum√©e.\n\n' +
                    '‚è∞ Vous pouvez aussi d√©clencher manuellement via: **Actions ‚Üí Process Articles & Deploy ‚Üí Run workflow**'
            })

      - name: Create deployment
        if: success() && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: 'Cloudflare Pages',
              auto_merge: false,
              required_contexts: []
            });

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: 'https://veille.pages.dev',
              description: 'D√©ploy√© sur Cloudflare Pages'
            });
